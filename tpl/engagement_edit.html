{include file="menu/management_menu.html"}

<script type="text/javascript" src="js/datepicker.js"></script>

<script type="text/javascript">



//------ JQUERY --------
jQuery(document).ready(function() {
   {if $locale != en}
      jQuery.datepicker.setDefaults($.datepicker.regional['{$locale}']);
   {/if}

   // Set the date
   jQuery("#engStartDate").datepicker("setDate" ,"{$engStartDate}");
   jQuery("#engDeadline").datepicker("setDate" ,"{$engDeadline}");

   $('#issues_table').dataTable(
      {
         "sScrollY": "700px",
         "bPaginate": false,
         "bScrollCollapse": true,
         "bFilter": true,
         "bSort": true,
         "bInfo": false,
         "bAutoWidth": false
      });

      jQuery(function() {
         jQuery( "#tabsEngagement" ).tabs();
      });

});

</script>


<div id="content">

   <br/><br/>

   <div  align="center">
      <h2>{$engName}</h2>
   </div>

   <br/><br/>

   <div>
      <!-- create form -->
      <form id='updateEngInfoForm' name='updateEngInfoForm' method='post' action='{$page}'>
      <fieldset>

         <table class='invisible'>
               <tr>
                  <th>{t}Team{/t}</th>
                  <td>
                     <select id='teamSelector' name='teamid'>
                        <!--option value='0'></option-->
                        {foreach from=$teams key=id item=i}
                        <option {if $i.selected}selected="selected"{/if} value="{$i.id}">{$i.name}</option>
                        {/foreach}
                     </select>
                  </td>
               </tr>
               <tr>
                  <th>{t}CommandSet{/t}</th>
                  <td>
                     <select id='commandsetSelector' name='commandsetid'>
                        <option value='0'>{t}--- not assigned ---{/t}</option>
                        {foreach from=$commandsets key=id item=i}
                        <option {if $i.selected}selected="selected"{/if} value="{$i.id}">{$i.name}</option>
                        {/foreach}
                     </select>
                  </td>
               </tr>
               <tr>
                  <th>{t}Name{/t}</th>
                  <td><input type='text' size='80' style='font-family: sans-serif' name='engName'  id='engName' value='{$engName}'></td>
               </tr>
               <tr>
                  <th>{t}Description{/t}</th>
                  <td><textarea rows='4' cols='80' style='font-family: sans-serif' name='engDesc'  id='engDesc'>{$engDesc}</textarea></td>
               </tr>
               <tr>
                  <th>{t}Date depart{/t}</th>
                  <td><input type="text" id="engStartDate"  name="engStartDate" class="datepicker" maxlength="10" size="10" title="{t}Start Date{/t}" />
                  </td>
               </tr>
               <tr>
                  <th>{t}Date fin{/t}</th>
                  <td><input type="text" id="engDeadline"  name="engDeadline" class="datepicker" maxlength="10" size="10" title="{t}Deadline{/t}" />
                  </td>
               </tr>
               <tr>
                  <th>{t}State{/t}</th>
                  <td>
                     <select id='stateSelector' name='engState'>
                        <option value='0'></option>
                        {foreach from=$engStateList key=id item=i}
                        <option {if $i.selected}selected="selected"{/if} value="{$i.id}">{$i.name}</option>
                        {/foreach}
                     </select>
                  </td>
               </tr>
               <tr>
                  <th>{t}Average Daily Rate{/t}</th>
                  <td><input type='text' style='font-family: sans-serif' name='engAverageDailyRate'  id='engAverageDailyRate' value='{$engAverageDailyRate}'> {t}Euro{/t}
                  </td>
               </tr>
               <tr>
                  <th>{t}Budjet Developpement{/t}</th>
                  <td><input type='text' style='font-family: sans-serif' name='engBudjetDev'  id='engBudjetDev' value='{$engBudjetDev}'> {t}days{/t}
                  </td>
               </tr>
               <tr>
                  <th>{t}Budjet Management{/t}</th>
                  <td><input type='text' style='font-family: sans-serif' name='engBudjetMngt'  id='engBudjetMngt' value='{$engBudjetMngt}'> {t}days{/t}
                  </td>
               </tr>
               <tr>
                  <th>{t}Budjet Garantie{/t}</th>
                  <td><input type='text' style='font-family: sans-serif' name='engBudjetGarantie'  id='engBudjetGarantie' value='{$engBudjetGarantie}'> {t}days{/t}</td>
               </tr>
         </table>
         <br>
         <button type='submit'><img  border='0' align='absmiddle' src="images/b_save.gif" alt="Save icon"/> {t}{$engInfoFormBtText}{/t}</button>

         <input type="hidden" name="action" value="{$engInfoFormAction}" />
         <input type="hidden" name="engid" value="{$engagementid}" />
      </fieldset>
      </form>

   </div>

   <br/><br/>


   <div style="margin-top:2em;">
   <br/><br/>

   <div id="tabsEngagement">
      <ul>
         <li><a href="#tabsName-1">{t}Tasks ({$engNbIssues}){/t}</a></li>
      </ul>

      <div id="tabsName-1">

         {if $isAddEngForm}
         <script type="text/javascript">
         //------ JQUERY --------
         jQuery(document).ready(function() {

            jQuery("#btAddEngIssue").click(function(event) {
               addEngIssue();
            });

            jQuery("#bugid").keypress(function(event) {
               if ( jQuery.ui.keyCode.ENTER == event.keyCode ) {
               addEngIssue();
               event.preventDefault();
               }
            });

            function addEngIssue(){

               // check fields
               var foundError = 0;
               var msgString = "{t}Missing field{/t}:\n\n";

               if ("" == document.forms["addEngIssueForm"].bugid.value) {
                  msgString += "{t}task id{/t}\n";
                  ++foundError;
               }

               if (0 == foundError) {
                  document.forms["addEngIssueForm"].submit();
               } else {
                  alert(msgString);
               }
            }


         });

         </script>

         <div>
            <!-- create form -->
            <form id='addEngIssueForm' name='addEngIssueForm' method='post' action='{$page}'>
               <fieldset>
                  <label>{t}Add task{/t}: </label>
                  <input id='bugid' name='bugid' type='text' size='5' value='' />
                  <input id="btAddEngIssue" type="button" value='{t}Add{/t}' />

                  <input type="hidden" name="action" value="addEngIssue" />
                  <input type="hidden" name="teamid" value="{$teamid}" />
                  <input type="hidden" name="engid" value="{$engagementid}" />
               </fieldset>
            </form>
         </div>
         {else}
         {t}Create the Engagement to add some tasks.{/t}
         {/if}

         {if $engIssues}
         <div align="center">

         <script type="text/javascript">
            function removeEngIssue(bugid, project, description){
               jQuery( "#desc_id" ).text(bugid);
               jQuery( "#desc_project" ).text(project);
               jQuery( "#desc_summary" ).text(description);

               jQuery( "#formRemoveEngIssue" ).find("input[name=bugid]").val(bugid);

               jQuery( "#removeEngIssue_dialog_form" ).dialog( "open" );
            }
         </script>
         <script type="text/javascript">
            jQuery(document).ready(function() {
               // delete track dialogBox
               jQuery("#removeEngIssue_dialog_form" ).dialog({
                  autoOpen: false,
                  resizable: true,
                  width: "auto",
                  modal: true,
                  buttons: {
                     "Remove": function() {
                        jQuery("#formRemoveEngIssue").submit();
                     },
                     Cancel: function() {
                        jQuery( this ).dialog( "close" );
                     }
                  }
               });
            });
         </script>
         <div id="removeEngIssue_dialog_form" title="{t}Remove Task{/t}" style="display: none">
            <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
               {t}Remove Task from this Engagement ?{/t}
            </p>
            <table class="invisible">
               <tr>
                  <td><span style="font-weight:bold;">{t}Id{/t} :</span></td>
                  <td id="desc_id">id</td>
               </tr>
               <tr>
                  <td><span style="font-weight:bold;">{t}Project{/t} :</span></td>
                  <td id="desc_project">project</td>
               </tr>
               <tr>
                  <td><span style="font-weight:bold;">{t}Summary{/t} :</span></td>
                  <td id="desc_summary">summary</td>
               </tr>
            </table>
            <form id="formRemoveEngIssue" name="formRemoveEngIssue" method="post" action="{$page}" >
               <fieldset>
                  <input type="hidden" name="action" value="removeEngIssue" />
                  <input type="hidden" name="bugid"  value="0" />
                  <input type="hidden" name="teamid" value="{$teamid}" />
                  <input type="hidden" name="engid"  value="{$engagementid}" />

               </fieldset>
            </form>
         </div>

         <table id="issues_table" class="display">
            <thead>
            <tr>
                  <th></th>
                  <th>{t}ID{/t}</th>
                  <th>{t}Project{/t}</th>
                  <th>{t}Target{/t}</th>
                  <th>{t}Summary{/t}</th>
            </tr>
            </thead>
            <tbody>
            {foreach $engIssues as $id => $issue}
            <tr>
                  <td>
                     <a title="{t}delete Engagement-Task association{/t}"
                        href="javascript: removeEngIssue('{$id}', '{$issue.project}', '{$issue.summary|escape}')">
                        <img alt="b_drop.png" border="0" src="images/b_drop.png" />
                     </a>
                  </td>
                  <td>{$issue.bugid}</td>
                  <td>{$issue.project}</td>
                  <td>{$issue.target}</td>
                  <td>{$issue.summary}</td>
            </tr>
            {/foreach}
            </tbody>
         </table>
         </div>
         {/if}

      </div>
      {if $engStats}
      <div id="tabsName-2">
      </div>
      {/if}

</div>
